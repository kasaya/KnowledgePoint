<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Kasaya 咔酱,kasaya@qq.com"><title>【activiti 工作流】activiti 7 中多实例并行会签的实现 · SLAYERS</title><meta name="description" content="在实现并行会签的时候，遇到了奇怪的问题，记录一下方便遇到同样问题的朋友快速解决问题。
问题起源首先，官方文档里提到如何使用多实例，以下是官方提供的sample：
123456&amp;lt;userTask id=&quot;miTasks&quot; name=&quot;My Task&quot; activiti:assignee=&quot;$&amp;#"><meta name="keywords" content="Spring,Spring Cloud,Java,JVM"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">SLAYERS</a></h3><div class="description"><p>老板！再来一碗！</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/head.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>【activiti 工作流】activiti 7 中多实例并行会签的实现</a></h3></div><div class="post-content"><p>在实现并行会签的时候，遇到了奇怪的问题，记录一下方便遇到同样问题的朋友快速解决问题。</p>
<h4 id="问题起源"><a href="#问题起源" class="headerlink" title="问题起源"></a>问题起源</h4><p>首先，官方文档里提到如何使用多实例，以下是官方提供的sample：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"miTasks"</span> <span class="attr">name</span>=<span class="string">"My Task"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;assignee&#125;"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">activiti:collection</span>=<span class="string">"assigneeList"</span> <span class="attr">activiti:elementVariable</span>=<span class="string">"assignee"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">completionCondition</span>&gt;</span>$&#123;nrOfCompletedInstances/nrOfInstances &gt;= 0.6 &#125;<span class="tag">&lt;/<span class="name">completionCondition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">multiInstanceLoopCharacteristics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>解释一下上面的代码，<br>assigneeList 为 集合，例如[“kermit”, “gonzo”, “fozzie”]；<br>activiti:elementVariable=”assignee”  为 接收 loop 中的值的变量名；<br>activiti:assignee=”${assignee}” 相当于将认领人指定为loop中取得的变量对象，就和java 中 foreach 差不多的意思；<br><strong>nrOfInstances</strong>：实例总数<br><strong>nrOfActiveInstances</strong>：当前活动（即尚未完成）实例的数量。对于顺序多实例，这将始终为1。<br><strong>nrOfCompletedInstances</strong>：已完成实例的数量。<br>注意，这三个变量存在当前执行的<strong>父执行</strong>中。<br><strong>${nrOfCompletedInstances/nrOfInstances &gt;= 0.6 }</strong> ，意思不言而喻，就是完成改执行的量大于等于60%就可以通过该节点进入下一节点。</p>
<p>整个这段就是完成会签的雏形。如果完成了60%，我认为绝大部分通过（这里的通过是指完成这个节点任务，和业务上的通过不同。），可以进入下一阶段。</p>
<p>官网就只写到这里。具体可以参考 <a href="https://www.activiti.org/userguide/#bpmnMultiInstance" target="_blank" rel="noopener">activiti 用户手册— 8.5.14。多实例（每个）</a></p>
<p>然后问题出现了。我参照上列配置，发现nrOfCompletedInstances 始终为0。所以完全没有触发停止循环的条件。</p>
<p>通过跟踪代码，发现当循环中的节点被complete 之后，会经过<strong>ParallelMultiInstanceBehavior</strong> 这个类的 <strong>leave(DelegateExecution execution)</strong> 方法</p>
<p>其中一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called when the wrapped &#123;<span class="doctag">@link</span> ActivityBehavior&#125; calls the &#123;<span class="doctag">@link</span> AbstractBpmnActivityBehavior#leave(ActivityExecution)&#125; method. Handles the completion of one of the parallel instances</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leave</span><span class="params">(DelegateExecution execution)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> zeroNrOfInstances = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (resolveNrOfInstances(execution) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Empty collection, just leave.</span></span><br><span class="line">      zeroNrOfInstances = <span class="keyword">true</span>;</span><br><span class="line">      removeLocalLoopVariable(execution, getCollectionElementIndexVariable());</span><br><span class="line">      <span class="keyword">super</span>.leave(execution); <span class="comment">// Plan the default leave</span></span><br><span class="line">      execution.setMultiInstanceRoot(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> loopCounter = getLoopVariable(execution, getCollectionElementIndexVariable());</span><br><span class="line">    <span class="keyword">int</span> nrOfInstances = getLoopVariable(execution, NUMBER_OF_INSTANCES);</span><br><span class="line">    <span class="keyword">int</span> nrOfCompletedInstances = getLoopVariable(execution, NUMBER_OF_COMPLETED_INSTANCES) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> nrOfActiveInstances = getLoopVariable(execution, NUMBER_OF_ACTIVE_INSTANCES) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Context.getCommandContext().getHistoryManager().recordActivityEnd((ExecutionEntity) execution, <span class="keyword">null</span>);</span><br><span class="line">    callActivityEndListeners(execution);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zeroNrOfInstances) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DelegateExecution miRootExecution = getMultiInstanceRootExecution(execution);</span><br><span class="line">    <span class="keyword">if</span> (miRootExecution != <span class="keyword">null</span>) &#123; <span class="comment">// will be null in case of empty collection</span></span><br><span class="line">      setLoopVariable(miRootExecution, NUMBER_OF_COMPLETED_INSTANCES, nrOfCompletedInstances);</span><br><span class="line">      setLoopVariable(miRootExecution, NUMBER_OF_ACTIVE_INSTANCES, nrOfActiveInstances);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这段代码里，nrOfCompletedInstances 是通过getLoopVariable(execution, NUMBER_OF_COMPLETED_INSTANCES)取得然后+1 得到的。<br>那我们猜想，这意思应该就是每次完成后，这个计数器就+1，然后存会到参数当中去，在下面的代码中setLoopVariable(miRootExecution, NUMBER_OF_COMPLETED_INSTANCES, nrOfCompletedInstances);<br>确实也说明他是这样的操作。</p>
<p>这样看设值应该没问题，那一定是取值有问题，然后我们看一下getLoopVariable方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Integer <span class="title">getLoopVariable</span><span class="params">(DelegateExecution execution, String variableName)</span> </span>&#123;</span><br><span class="line">    Object value = execution.getVariableLocal(variableName);</span><br><span class="line">    DelegateExecution parent = execution.getParent();</span><br><span class="line">    <span class="keyword">while</span> (value == <span class="keyword">null</span> &amp;&amp; parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">      value = parent.getVariableLocal(variableName);</span><br><span class="line">      parent = parent.getParent();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (Integer) (value != <span class="keyword">null</span> ? value : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>很明显了，先从当前的execution 中取值，如果没有，那就从父对象中取。</p>
<p>我在代码的任何地方都未曾配置过nrOfCompletedInstances这个变量。按理说应该value为null, 但是debug过程中发现，<strong>value值为0！！！</strong> 这就直接到导致，每次就取的是当前execution 的值。而设置的时候，又是将值设置在了父execution 的变量当中。所以每次的这个变量值就不会改变。都是从0-&gt;1的变化。</p>
<p>####解决问题####<br>思路：添加监听器，在执行leave 方法前，将父execution 中的变量值，放到当前变量中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">"miTasks"</span> <span class="attr">name</span>=<span class="string">"My Task"</span> <span class="attr">activiti:assignee</span>=<span class="string">"$&#123;assignee&#125;"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activiti:taskListener</span> <span class="attr">event</span>=<span class="string">"complete"</span> <span class="attr">delegateExpression</span>=<span class="string">"$&#123;counterSignCompleteListener&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activiti:taskListener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">modeler:initiator-can-complete</span> <span class="attr">xmlns:modeler</span>=<span class="string">"http://activiti.com/modeler"</span>&gt;</span>&lt;![CDATA[false]]&gt;    </span><br><span class="line">     <span class="tag">&lt;/<span class="name">modeler:initiator-can-complete</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">extensionElements</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">multiInstanceLoopCharacteristics</span> <span class="attr">isSequential</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">activiti:collection</span>=<span class="string">"assigneeList"</span> <span class="attr">activiti:elementVariable</span>=<span class="string">"assignee"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">completionCondition</span>&gt;</span>$&#123;nrOfCompletedInstances/nrOfInstances &gt;= 0.6 &#125;<span class="tag">&lt;/<span class="name">completionCondition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">multiInstanceLoopCharacteristics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在监听里修改值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterSignCompleteListener</span> <span class="keyword">implements</span> <span class="title">TaskListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(DelegateTask delegateTask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       Integer completedInstances = Integer.valueOf(String.valueOf(delegateTask.getExecution().getParent().getVariable(<span class="string">"nrOfCompletedInstances"</span>)));</span><br><span class="line">       Integer nrOfActiveInstances = Integer.valueOf(String.valueOf(delegateTask.getExecution().getParent().getVariable(<span class="string">"nrOfActiveInstances"</span>)));</span><br><span class="line"></span><br><span class="line">        delegateTask.setVariableLocal(<span class="string">"nrOfCompletedInstances"</span>, completedInstances);</span><br><span class="line">        delegateTask.setVariableLocal(<span class="string">"nrOfActiveInstances"</span>, nrOfActiveInstances);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样在调用的时候，变量就能正常自增，就达到想要的结果了。</p>
<hr>
<p>这次问题我决定不是最好的解决办法，因为很多细节的地方仍旧没有弄明白，我一直认为是我自己的配置出了问题才会有这样的结果，否则官网指导也不会值是给那么简单的sample就说可以完成任务了。所以希望有明白的朋友留言给我，我也希望能从根本解决问题。~~谢谢大家</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-08-03</span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="date" id="busuanzi_container_page_pv">阅读数：<span id="busuanzi_value_page_pv">次 </span></span><i class="fa fa-tag"></i><a class="tag" href="/categories/activiti/" title="activiti">activiti </a><a class="tag" href="/tags/activiti7/" title="activiti7">activiti7 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/08/03/activiti-countersign/,SLAYERS,【activiti 工作流】activiti 7 中多实例并行会签的实现,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/08/03/jvm-learn2/" title="【JVM学习笔记】第二章-自动内存管理机制">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/08/03/activiti-spring-boot/" title="【activiti 工作流】关于acitiviti 和 spring boot 集成遇到的一些问题总结">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>